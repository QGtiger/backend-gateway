# Backend Gateway

åŸºäº NestJS çš„ API ç½‘å…³æœåŠ¡ï¼Œæä¾›ç»Ÿä¸€çš„è®¤è¯ã€è¯·æ±‚è½¬å‘å’Œé”™è¯¯å¤„ç†åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### ğŸ” è®¤è¯åŠŸèƒ½

- **JWT Token éªŒè¯**ï¼šä½¿ç”¨ JWT å¯†é’¥éªŒè¯å®¢æˆ·ç«¯ Token
- **ç”¨æˆ·ä¿¡æ¯æå–**ï¼šä» Token ä¸­æå– `userId` å’Œ `username`
- **ç”¨æˆ·ä¿¡æ¯æ³¨å…¥**ï¼šå°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡è¯·æ±‚å¤´ä¼ é€’ç»™ä¸šåŠ¡æœåŠ¡
- **å…¬å¼€è·¯ç”±æ”¯æŒ**ï¼šæ”¯æŒé…ç½®å…¬å¼€è·¯å¾„å‰ç¼€ï¼Œæ— éœ€è®¤è¯å³å¯è®¿é—®

### ğŸ”„ è¯·æ±‚ä»£ç†

- **æ™ºèƒ½è·¯ç”±è½¬å‘**ï¼šæ ¹æ®è·¯å¾„å‰ç¼€è‡ªåŠ¨è½¬å‘åˆ°å¯¹åº”çš„ä¸šåŠ¡æœåŠ¡
- **è¯·æ±‚å¤´å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†æ•æ„Ÿå¤´ä¿¡æ¯ï¼Œæ³¨å…¥ç”¨æˆ·ä¿¡æ¯
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- **è¶…æ—¶æ§åˆ¶**ï¼šæ”¯æŒä¸ºæ¯ä¸ªæœåŠ¡é…ç½®è¶…æ—¶æ—¶é—´

### ğŸ›¡ï¸ é”™è¯¯å¤„ç†

- **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šæ‰€æœ‰é”™è¯¯å“åº”ç»Ÿä¸€ä¸º `{ success, code, message }` æ ¼å¼
- **HTTP çŠ¶æ€ç ç»Ÿä¸€**ï¼šæ‰€æœ‰é”™è¯¯å“åº” HTTP çŠ¶æ€ç ä¸º 200ï¼Œå®é™…çŠ¶æ€ç é€šè¿‡ `code` å­—æ®µè¡¨ç¤º
- **å…¨å±€å¼‚å¸¸æ•è·**ï¼šè‡ªåŠ¨æ•è·å¹¶æ ¼å¼åŒ–æ‰€æœ‰å¼‚å¸¸

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šNestJS 10.x
- **è¯­è¨€**ï¼šTypeScript 5.x
- **è®¤è¯**ï¼š@nestjs/jwt
- **ä»£ç†**ï¼šhttp-proxy-middleware
- **é…ç½®ç®¡ç†**ï¼š@nestjs/config

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ common/                    # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ decorators/           # è£…é¥°å™¨
â”‚   â”‚   â””â”€â”€ public.decorator.ts    # å…¬å¼€è·¯ç”±è£…é¥°å™¨
â”‚   â””â”€â”€ filters/              # è¿‡æ»¤å™¨
â”‚       â””â”€â”€ http-exception.filter.ts  # å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ services.ts           # æœåŠ¡é…ç½®
â”œâ”€â”€ modules/                   # åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ auth/                 # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts   # Token éªŒè¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ guards/
â”‚   â”‚       â””â”€â”€ auth.guard.ts # è®¤è¯å®ˆå«
â”‚   â””â”€â”€ proxy/                # ä»£ç†æ¨¡å—
â”‚       â”œâ”€â”€ proxy.module.ts
â”‚       â””â”€â”€ proxy.service.ts  # ä»£ç†æœåŠ¡
â”œâ”€â”€ app.controller.ts         # ä¸»æ§åˆ¶å™¨
â”œâ”€â”€ app.module.ts             # ä¸»æ¨¡å—
â””â”€â”€ main.ts                   # åº”ç”¨å…¥å£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.x
- pnpm >= 8.x (æˆ– npm/yarn)

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# ç½‘å…³ç«¯å£
PORT=3000

# JWTå¯†é’¥ï¼ˆè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å¼ºå¯†é’¥ï¼‰
JWT_SECRET=your-secret-key-change-in-production

# å…¬å¼€è·¯å¾„åˆ—è¡¨ï¼ˆä¸éœ€è¦è®¤è¯çš„è·¯å¾„ï¼Œç”¨é€—å·åˆ†éš”ï¼‰
PUBLIC_PATHS=/health

# å…¬å¼€å‰ç¼€åˆ—è¡¨ï¼ˆä¸éœ€è¦è®¤è¯çš„è·¯å¾„å‰ç¼€ï¼Œç”¨é€—å·åˆ†éš”ï¼‰
# æ‰€æœ‰ä»¥è¿™äº›å‰ç¼€å¼€å¤´çš„è·¯å¾„éƒ½ä¼šè·³è¿‡è®¤è¯
PUBLIC_PREFIXES=/public,/open
```

### é…ç½®æœåŠ¡è·¯ç”±

ç¼–è¾‘ `src/config/services.ts`ï¼š

```typescript
export const ALL_SERVICES: ServiceConfig[] = [
  {
    path: '/api/users', // è·¯å¾„å‰ç¼€
    target: 'http://localhost:3001', // ç›®æ ‡æœåŠ¡åœ°å€
    requiresAuth: true, // æ˜¯å¦éœ€è¦è®¤è¯
    timeout: 10000, // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    changeOrigin: true, // æ˜¯å¦ä¿®æ”¹ Host å¤´
  },
  {
    path: '/api/orders',
    target: 'http://localhost:3002',
    requiresAuth: true,
    timeout: 15000,
    changeOrigin: true,
  },
];
```

### å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
pnpm run start:dev

# ç”Ÿäº§æ¨¡å¼
pnpm run build
pnpm run start:prod
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡å            | è¯´æ˜                         | é»˜è®¤å€¼ | å¿…å¡« |
| ----------------- | ---------------------------- | ------ | ---- |
| `PORT`            | ç½‘å…³ç«¯å£                     | 3000   | å¦   |
| `JWT_SECRET`      | JWT å¯†é’¥                     | -      | æ˜¯   |
| `PUBLIC_PATHS`    | å…¬å¼€è·¯å¾„åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰     | -      | å¦   |
| `PUBLIC_PREFIXES` | å…¬å¼€è·¯å¾„å‰ç¼€åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ | -      | å¦   |

### æœåŠ¡é…ç½®

æ¯ä¸ªæœåŠ¡é…ç½®åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ           | ç±»å‹    | è¯´æ˜                   | å¿…å¡«             |
| -------------- | ------- | ---------------------- | ---------------- |
| `path`         | string  | è·¯å¾„å‰ç¼€ï¼Œç”¨äºåŒ¹é…è¯·æ±‚ | æ˜¯               |
| `target`       | string  | ç›®æ ‡æœåŠ¡åœ°å€           | æ˜¯               |
| `requiresAuth` | boolean | æ˜¯å¦éœ€è¦è®¤è¯           | å¦ï¼ˆé»˜è®¤ trueï¼‰  |
| `timeout`      | number  | è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰       | å¦ï¼ˆé»˜è®¤ 30000ï¼‰ |
| `changeOrigin` | boolean | æ˜¯å¦ä¿®æ”¹ Host å¤´       | å¦ï¼ˆé»˜è®¤ trueï¼‰  |
| `pathRewrite`  | object  | è·¯å¾„é‡å†™è§„åˆ™           | å¦               |

## ğŸ“š API æ–‡æ¡£

### å¥åº·æ£€æŸ¥

```http
GET /health
```

**å“åº”ï¼š**

```json
{
  "status": "ok",
  "timestamp": "2024-11-27T16:35:00.000Z"
}
```

### ä»£ç†è¯·æ±‚

æ‰€æœ‰åŒ¹é…æœåŠ¡é…ç½®çš„è¯·æ±‚éƒ½ä¼šè¢«ä»£ç†åˆ°å¯¹åº”çš„ä¸šåŠ¡æœåŠ¡ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```http
GET /api/users/123
Authorization: Bearer <token>
```

**ç½‘å…³å¤„ç†æµç¨‹ï¼š**

1. éªŒè¯ Tokenï¼ˆå¦‚æœè·¯å¾„éœ€è¦è®¤è¯ï¼‰
2. æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆuserId, usernameï¼‰
3. è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡
4. åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `x-user-id` å’Œ `x-username`
5. è¿”å›ä¸šåŠ¡æœåŠ¡å“åº”

**ä¸šåŠ¡æœåŠ¡æ¥æ”¶åˆ°çš„è¯·æ±‚å¤´ï¼š**

```http
x-user-id: 123
x-username: john
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å…¬å¼€è·¯ç”±ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨è£…é¥°å™¨

```typescript
@Get('/public/info')
@Public()
getPublicInfo() {
  return { message: 'This is public' };
}
```

#### æ–¹å¼äºŒï¼šé…ç½®å…¬å¼€å‰ç¼€

åœ¨ `.env` ä¸­é…ç½®ï¼š

```env
PUBLIC_PREFIXES=/public,/open
```

æ‰€æœ‰ä»¥ `/public` æˆ– `/open` å¼€å¤´çš„è·¯å¾„éƒ½ä¼šè·³è¿‡è®¤è¯ã€‚

### 2. éœ€è¦è®¤è¯çš„è·¯ç”±

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è·¯ç”±éƒ½éœ€è¦è®¤è¯ã€‚å®¢æˆ·ç«¯éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ Tokenï¼š

```http
GET /api/users/123
Authorization: Bearer <your-jwt-token>
```

### 3. é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰é”™è¯¯å“åº”ç»Ÿä¸€æ ¼å¼ï¼š

```json
{
  "success": false,
  "code": 401,
  "message": "Token not found",
  "timestamp": "2024-11-27T16:35:00.000Z",
  "path": "/api/users"
}
```

**æ³¨æ„**ï¼šHTTP çŠ¶æ€ç ç»Ÿä¸€ä¸º 200ï¼Œå®é™…çŠ¶æ€ç é€šè¿‡ `code` å­—æ®µè¡¨ç¤ºã€‚

### 4. å¸¸è§é”™è¯¯ç 

| code | è¯´æ˜                         |
| ---- | ---------------------------- |
| 401  | è®¤è¯å¤±è´¥ï¼ˆToken æ— æ•ˆæˆ–ç¼ºå¤±ï¼‰ |
| 404  | æœåŠ¡æœªæ‰¾åˆ°æˆ–è·¯ç”±ä¸å­˜åœ¨       |
| 502  | ç›®æ ‡æœåŠ¡ä¸å¯ç”¨               |
| 500  | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯               |

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æœåŠ¡

1. åœ¨ `src/config/services.ts` ä¸­æ·»åŠ æœåŠ¡é…ç½®ï¼š

```typescript
{
  path: '/api/new-service',
  target: 'http://localhost:3004',
  requiresAuth: true,
  timeout: 10000,
  changeOrigin: true,
}
```

2. é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆã€‚

### è‡ªå®šä¹‰é”™è¯¯å¤„ç†

ä¿®æ”¹ `src/common/filters/http-exception.filter.ts` æ¥è‡ªå®šä¹‰é”™è¯¯å“åº”æ ¼å¼ã€‚

### æ·»åŠ ä¸­é—´ä»¶

åœ¨ `src/main.ts` ä¸­æ·»åŠ å…¨å±€ä¸­é—´ä»¶ï¼š

```typescript
app.use(cors());
app.use(helmet());
```

### è¿è¡Œæµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
pnpm run test

# æµ‹è¯•è¦†ç›–ç‡
pnpm run test:cov

# E2E æµ‹è¯•
pnpm run test:e2e
```

## ğŸ“¦ æ„å»ºå’Œéƒ¨ç½²

### æ„å»º

```bash
pnpm run build
```

æ„å»ºäº§ç‰©åœ¨ `dist/` ç›®å½•ã€‚

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆç‰¹åˆ«æ˜¯ `JWT_SECRET`ï¼‰
2. æ„å»ºé¡¹ç›®
3. è¿è¡Œï¼š

```bash
pnpm run start:prod
```

### Docker éƒ¨ç½²

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN pnpm install --prod
COPY dist ./dist
CMD ["node", "dist/main"]
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **JWT å¯†é’¥**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºå¯†é’¥ï¼Œå»ºè®®è‡³å°‘ 32 å­—ç¬¦
2. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
3. **CORS**ï¼šæ ¹æ®å®é™…éœ€æ±‚é…ç½® CORS
4. **é™æµ**ï¼šå»ºè®®æ·»åŠ é™æµä¸­é—´ä»¶é˜²æ­¢ API æ»¥ç”¨
5. **æ—¥å¿—**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ æ—¥å¿—æ”¶é›†

## ğŸ“„ è®¸å¯è¯

UNLICENSED

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issueã€‚
